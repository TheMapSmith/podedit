---
phase: 04-cut-point-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - index.html
  - src/controllers/transcriptController.js
autonomous: true

must_haves:
  truths:
    - "User can mark a start point at current audio position"
    - "User can mark an end point to complete a cut region"
    - "Cut regions are visually highlighted in transcript"
    - "User can see list of all cut regions with timestamps"
    - "User can delete cut regions from the list"
  artifacts:
    - path: "index.html"
      provides: "Cut marking buttons and cut list UI"
      contains: "mark-start-btn"
    - path: "src/controllers/transcriptController.js"
      provides: "Cut region visual highlighting in transcript"
      contains: "highlightCutRegions"
  key_links:
    - from: "index.html"
      to: "src/controllers/cutController.js"
      via: "cutController.markStart/markEnd calls"
      pattern: "cutController\\.mark"
    - from: "index.html"
      to: "src/controllers/transcriptController.js"
      via: "transcriptController.highlightCutRegions"
      pattern: "highlightCutRegions"
---

<objective>
Add UI for marking cut regions and displaying them in the transcript.

Purpose: Deliver the core user-facing cut marking functionality. User can mark start/end points, see regions highlighted in transcript, and view a list of all marked regions. This plan fully delivers CUT-03 (visual indication of marked regions) through both transcript highlighting and the cut list display.

Output: Mark Start/End buttons, cut region list panel, and visual highlighting of cut regions in transcript.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-cut-point-management/04-01-PLAN.md

# Existing code
@src/controllers/transcriptController.js
@src/controllers/cutController.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cut marking buttons and cut list UI to index.html</name>
  <files>index.html</files>
  <action>
Add cut marking controls after the transcription section. Add these HTML elements:

1. After `</div>` closing transcription-section, add a new section:
```html
<div id="cut-section" class="cut-section hidden">
  <div class="cut-controls">
    <h2>Cut Regions</h2>
    <div class="cut-buttons">
      <button id="mark-start-btn" disabled>Mark Start</button>
      <button id="mark-end-btn" disabled>Mark End</button>
      <span id="pending-cut-status" class="pending-status"></span>
    </div>
  </div>

  <div id="cut-list" class="cut-list">
    <p class="cut-placeholder">No cuts marked yet. Use "Mark Start" and "Mark End" to define regions to remove.</p>
  </div>
</div>
```

2. Add CSS styles in the `<style>` section:
```css
.cut-section {
  margin-top: 30px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.cut-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.cut-controls h2 {
  font-size: 20px;
  color: #333;
  margin: 0;
}

.cut-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
}

#mark-start-btn {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  background: #dc3545;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

#mark-start-btn:hover:not(:disabled) {
  background: #c82333;
}

#mark-start-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
  opacity: 0.6;
}

#mark-end-btn {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  background: #28a745;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

#mark-end-btn:hover:not(:disabled) {
  background: #218838;
}

#mark-end-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
  opacity: 0.6;
}

.pending-status {
  font-size: 13px;
  color: #dc3545;
  font-weight: 500;
}

.cut-list {
  max-height: 200px;
  overflow-y: auto;
  padding: 10px;
  background: white;
  border-radius: 4px;
  border: 1px solid #dee2e6;
}

.cut-placeholder {
  color: #6c757d;
  font-style: italic;
  margin: 0;
}

.cut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  margin: 4px 0;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 4px;
}

.cut-item-info {
  font-size: 14px;
  color: #333;
}

.cut-item-label {
  font-weight: 600;
  margin-right: 8px;
}

.cut-item-times {
  font-variant-numeric: tabular-nums;
}

.cut-item-actions {
  display: flex;
  gap: 8px;
}

.cut-item-delete {
  padding: 4px 8px;
  font-size: 12px;
  color: #dc3545;
  background: white;
  border: 1px solid #dc3545;
  border-radius: 4px;
  cursor: pointer;
}

.cut-item-delete:hover {
  background: #dc3545;
  color: white;
}

/* Transcript segment cut highlighting */
.transcript-segment.in-cut-region {
  background-color: #fff3cd;
  border-left: 3px solid #ffc107;
}

.transcript-segment.in-cut-region.active {
  background-color: #ffe066;
}
```

3. Add element references in the elements object:
```javascript
cutSection: document.getElementById('cut-section'),
markStartBtn: document.getElementById('mark-start-btn'),
markEndBtn: document.getElementById('mark-end-btn'),
pendingCutStatus: document.getElementById('pending-cut-status'),
cutList: document.getElementById('cut-list')
```

4. Wire up button click handlers after CutController instantiation:
```javascript
// Show cut section when file is loaded (add in file load success block)
elements.cutSection.classList.remove('hidden');
elements.markStartBtn.disabled = false;

// Mark Start button
elements.markStartBtn.addEventListener('click', () => {
  const currentTime = audioService.getCurrentTime();
  cutController.markStart(currentTime);
});

// Mark End button
elements.markEndBtn.addEventListener('click', () => {
  const currentTime = audioService.getCurrentTime();
  cutController.markEnd(currentTime);
});

// CutController callbacks
cutController.onPendingCutChanged = (pendingCut) => {
  if (pendingCut) {
    elements.pendingCutStatus.textContent = `Start marked at ${formatCutTime(pendingCut.startTime)}`;
    elements.markEndBtn.disabled = false;
  } else {
    elements.pendingCutStatus.textContent = '';
    elements.markEndBtn.disabled = true;
  }
};

cutController.onCutListChanged = (cuts) => {
  renderCutList(cuts);
  if (transcriptController && transcriptController.transcript) {
    transcriptController.highlightCutRegions(cuts);
  }
};

// Helper to format time for cut display
// Note: Output format is M:SS (e.g., "5:30" not "05:30"). This is acceptable
// as the input parser in Plan 03 accepts both "5:30" and "05:30" formats.
function formatCutTime(seconds) {
  if (!isFinite(seconds) || isNaN(seconds) || seconds < 0) return '--:--';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${String(secs).padStart(2, '0')}`;
}

// Render cut list
function renderCutList(cuts) {
  if (cuts.length === 0) {
    elements.cutList.innerHTML = '<p class="cut-placeholder">No cuts marked yet. Use "Mark Start" and "Mark End" to define regions to remove.</p>';
    return;
  }

  elements.cutList.innerHTML = cuts.map((cut, index) => `
    <div class="cut-item" data-cut-id="${cut.id}">
      <div class="cut-item-info">
        <span class="cut-item-label">Cut ${index + 1}:</span>
        <span class="cut-item-times">${formatCutTime(cut.startTime)} - ${formatCutTime(cut.endTime)}</span>
      </div>
      <div class="cut-item-actions">
        <button class="cut-item-delete" data-cut-id="${cut.id}">Delete</button>
      </div>
    </div>
  `).join('');

  // Wire delete buttons
  elements.cutList.querySelectorAll('.cut-item-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const cutId = e.target.getAttribute('data-cut-id');
      cutController.deleteCut(cutId);
    });
  });
}
```

5. Initialize mark end button as disabled on page load (before file is loaded):
The mark-end-btn should start disabled and only enable when there's a pending cut.
  </action>
  <verify>
Open app in browser:
1. Load an audio file - cut section should appear
2. Click "Mark Start" - status shows "Start marked at X:XX", "Mark End" enables
3. Click "Mark End" - cut appears in list
4. Create another cut - appears in list as "Cut 2"
5. Click "Delete" on cut item - cut removed from list, list updates
6. Delete all cuts - placeholder text reappears
  </verify>
  <done>Cut section UI added with Mark Start/End buttons, cut list display, and delete functionality</done>
</task>

<task type="auto">
  <name>Task 2: Add cut region highlighting to TranscriptController</name>
  <files>src/controllers/transcriptController.js</files>
  <action>
Add method to TranscriptController that highlights transcript segments within cut regions:

1. Add a `highlightCutRegions` method to the class:
```javascript
/**
 * Highlight transcript segments that fall within cut regions
 * @param {CutRegion[]} cutRegions - Array of cut regions
 */
highlightCutRegions(cutRegions) {
  // Guard: no transcript loaded
  if (!this.transcript || !this.transcript.segments) {
    return;
  }

  const segmentElements = this.elements.transcriptContainer.querySelectorAll('.transcript-segment');

  segmentElements.forEach((element, index) => {
    const segment = this.transcript.segments[index];
    if (!segment) return;

    // Check if this segment overlaps with any cut region
    // Note: cut.isComplete() is a method on CutRegion, not a property
    const isInCut = cutRegions.some(cut => {
      if (!cut.isComplete()) {
        return false;
      }
      // Segment overlaps cut if: segment.start < cut.end AND segment.end > cut.start
      return segment.start < cut.endTime && segment.end > cut.startTime;
    });

    // Toggle the in-cut-region class
    if (isInCut) {
      element.classList.add('in-cut-region');
    } else {
      element.classList.remove('in-cut-region');
    }
  });
}

/**
 * Clear all cut region highlighting from transcript
 */
clearCutHighlights() {
  const segmentElements = this.elements.transcriptContainer.querySelectorAll('.transcript-segment');
  segmentElements.forEach(element => {
    element.classList.remove('in-cut-region');
  });
}
```

2. Update cleanup method to also clear cut highlights:
In the `cleanup()` method, add `this.clearCutHighlights();` before clearing the container.
  </action>
  <verify>
After marking a cut region:
1. Transcript segments within the cut time range have yellow background and left border
2. Deleting cut region removes highlighting from those segments
3. Segments can show both "active" (current playback) and "in-cut-region" states
4. Verify cleanup() calls clearCutHighlights() to prevent stale highlighting state
  </verify>
  <done>TranscriptController has highlightCutRegions method that visually marks segments within cut regions, and cleanup properly clears cut highlighting</done>
</task>

</tasks>

<verification>
Manual testing in browser:
1. Load audio file - cut section visible, Mark Start enabled
2. Click Mark Start - status shows time, Mark End enables
3. Click Mark End - cut appears in list with correct timestamps
4. Generate transcript - segments within cut region show yellow highlight
5. Mark another cut - both cuts in list, both highlighted in transcript
6. Delete one cut - removed from list, highlighting updated
7. Play audio - active segment highlighting works with cut region highlighting
</verification>

<success_criteria>
- User can mark start point with Mark Start button (CUT-01)
- User can mark end point with Mark End button (CUT-02)
- Cut regions are visually highlighted in transcript with yellow/gold background (CUT-03)
- User can see list of all cut regions with timestamps (CUT-03)
- User can delete cut regions (CUT-05)
- Active playback highlighting and cut region highlighting coexist
</success_criteria>

<output>
After completion, create `.planning/phases/04-cut-point-management/04-02-SUMMARY.md`
</output>
