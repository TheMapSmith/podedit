---
phase: 01-audio-playback-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - src/services/audioService.js
  - src/services/fileValidator.js
  - src/utils/timeFormat.js
autonomous: true

must_haves:
  truths:
    - "Audio file can be loaded into memory-efficient streaming audio element"
    - "File format validation rejects unsupported formats with clear error message"
    - "File size validation rejects files over 500MB with clear error message"
    - "Time formatting displays MM:SS for short files and HH:MM:SS for long files"
  artifacts:
    - path: "index.html"
      provides: "Basic HTML structure with file input"
      min_lines: 20
    - path: "src/services/audioService.js"
      provides: "Audio element lifecycle management with streaming"
      exports: ["AudioService"]
    - path: "src/services/fileValidator.js"
      provides: "MIME type and size validation"
      exports: ["validateAudioFile", "SUPPORTED_AUDIO_FORMATS"]
    - path: "src/utils/timeFormat.js"
      provides: "Time formatting utilities"
      exports: ["formatTime", "formatFileSize"]
  key_links:
    - from: "src/services/audioService.js"
      to: "URL.createObjectURL"
      via: "object URL creation for streaming"
      pattern: "URL\\.createObjectURL"
    - from: "src/services/audioService.js"
      to: "URL.revokeObjectURL"
      via: "memory cleanup on file change"
      pattern: "URL\\.revokeObjectURL"
---

<objective>
Create the project foundation with audio streaming service and file validation.

Purpose: Establish the core audio infrastructure that enables memory-efficient playback of large podcast files (45-90 minutes) without browser memory issues. This is the foundation all other Phase 1 work builds on.

Output:
- Basic HTML shell with file input
- AudioService class for streaming audio playback
- File validation for format and size checking
- Time formatting utilities
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-playback-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and utility modules</name>
  <files>
    - src/utils/timeFormat.js
    - src/services/fileValidator.js
  </files>
  <action>
Create the project directory structure:
```
src/
  services/
  utils/
```

Create `src/utils/timeFormat.js` with:
- `formatTime(seconds)` - converts seconds to MM:SS or HH:MM:SS (include hours only when >= 1 hour). Handle NaN/Infinity by returning "--:--"
- `formatFileSize(bytes)` - converts bytes to human-readable format (KB, MB)

Create `src/services/fileValidator.js` with:
- `SUPPORTED_AUDIO_FORMATS` constant mapping MIME types to extensions:
  - audio/mpeg, audio/mp3 -> .mp3
  - audio/wav, audio/wave, audio/x-wav -> .wav
  - audio/mp4, audio/x-m4a -> .m4a
  - audio/aac -> .aac
  - audio/ogg -> .ogg
- `MAX_FILE_SIZE` constant = 500MB
- `validateAudioFile(file)` function that:
  - Returns `{ valid: false, errors: ['No file provided'] }` if no file
  - Checks MIME type against SUPPORTED_AUDIO_FORMATS
  - Checks file size against MAX_FILE_SIZE
  - Returns `{ valid: boolean, errors: string[], fileInfo: { name, size, type, sizeFormatted } }`

Use ES modules (export/import syntax).
  </action>
  <verify>
Open browser dev console and test:
```javascript
import { formatTime } from './src/utils/timeFormat.js';
console.log(formatTime(125));  // Should output "2:05"
console.log(formatTime(3725)); // Should output "1:02:05"
console.log(formatTime(NaN));  // Should output "--:--"
```
  </verify>
  <done>
- formatTime returns "2:05" for 125 seconds, "1:02:05" for 3725 seconds, "--:--" for NaN
- formatFileSize returns "45.2 MB" for 47396044 bytes
- validateAudioFile returns valid:true for .mp3 file under 500MB
- validateAudioFile returns valid:false with error for .txt file
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AudioService with streaming support</name>
  <files>
    - src/services/audioService.js
  </files>
  <action>
Create `src/services/audioService.js` with an AudioService class:

Constructor:
- Create new Audio() element
- Set preload = 'metadata' (critical for large file streaming)
- Initialize listeners Map for cleanup tracking

Methods:
- `loadFile(file)` - async, creates object URL with URL.createObjectURL(), sets audio.src, returns Promise that resolves with { duration, seekable } when loadedmetadata fires. IMPORTANT: Check audio.readyState > 0 first in case metadata already loaded. Call cleanup() first to revoke any existing object URL.

- `play()` - async, calls audio.play(), catches NotAllowedError for autoplay blocking, returns Promise

- `pause()` - calls audio.pause()

- `seek(timeInSeconds)` - sets audio.currentTime (validate within 0 to duration range)

- `getCurrentTime()` - returns audio.currentTime

- `getDuration()` - returns audio.duration

- `isPlaying()` - returns !audio.paused && !audio.ended && audio.readyState > 2

- `on(eventName, callback)` - adds event listener to audio element, stores in listeners Map for cleanup

- `off(eventName, callback)` - removes event listener

- `cleanup()` - pauses audio, revokes object URL if src starts with 'blob:', clears src, removes all stored listeners

Export default AudioService.

Key patterns from research:
- Always revoke object URLs to prevent memory leaks
- Use preload="metadata" to avoid loading entire file
- Handle readyState check before waiting for loadedmetadata event
  </action>
  <verify>
Create test.html that imports AudioService and verify in browser console:
```javascript
const service = new AudioService();
// After loading a file via input:
console.log(service.getDuration()); // Should show duration in seconds
console.log(service.isPlaying()); // Should be false initially
```
  </verify>
  <done>
- AudioService can be instantiated without errors
- loadFile() returns Promise with duration when file is loaded
- cleanup() revokes object URL (verify no memory leak in DevTools Memory tab)
- Object URL is properly revoked when loading a new file (no blob: URLs accumulating)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create basic HTML shell</name>
  <files>
    - index.html
  </files>
  <action>
Create `index.html` at project root with:

HTML structure:
- DOCTYPE html, lang="en"
- Meta viewport for mobile
- Title: "PodEdit"
- Basic styling in style tag:
  - System font stack (system-ui, -apple-system, sans-serif)
  - Max-width container (800px, centered)
  - Player container with border, rounded corners, padding

Body content:
- h1: "PodEdit"
- File input with id="file-input", accept="audio/*"
- Div for file info display (id="file-info", initially hidden)
- Div for error display (id="error", styled red)
- Player controls container (id="player-controls", initially hidden):
  - Play/pause button (id="play-button")
  - Seek slider (input type="range", id="seek-slider", min=0, max=100, value=0)
  - Time display div with current time (id="current-time") and duration (id="duration")

Script tag with type="module" that:
- Imports AudioService
- Imports validateAudioFile
- Imports formatTime, formatFileSize
- Sets up file input change handler that:
  - Validates file with validateAudioFile
  - Shows error if invalid
  - Loads file with AudioService
  - Shows file info (name, size)
  - Shows player controls
  - Updates duration display

This task creates the HTML shell only. Full interactivity is in Plan 02.
  </action>
  <verify>
1. Open index.html in browser (can use `python3 -m http.server 8000` or similar)
2. File input should be visible
3. Select an MP3 file - file info should appear, player controls should become visible
4. Duration should display correctly (e.g., "45:23" for a 45-minute file)
5. Check console for any import errors
  </verify>
  <done>
- index.html loads without errors in browser
- File input accepts audio files
- Selecting valid audio file shows file info and reveals player controls
- Duration displays in correct format
- Selecting invalid file shows error message
- No console errors on page load
  </done>
</task>

</tasks>

<verification>
Run local server and test end-to-end:

```bash
cd /home/sprite/podedit && python3 -m http.server 8000
```

1. Open http://localhost:8000 in browser
2. Page loads without console errors
3. Upload a short MP3 file (<5MB) - validates successfully, shows info
4. Upload a large MP3 file (60+ min podcast) - validates successfully, shows duration
5. Try uploading a .txt file - shows validation error
6. Check DevTools Memory tab - no excessive memory usage after loading large file
7. Import modules work correctly (no 404 errors in Network tab)
</verification>

<success_criteria>
- Project structure exists: src/services/, src/utils/
- AudioService streams large files without loading entirely into memory
- File validation correctly accepts MP3/WAV/M4A/OGG and rejects other formats
- Time formatting handles edge cases (NaN, hours, zero-padding)
- HTML page loads and displays file info when audio uploaded
- Duration displays correctly for both short and long files
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-playback-foundation/01-01-SUMMARY.md`

Document:
- Files created with brief descriptions
- Any implementation decisions made
- What's ready for Plan 02 to build on
</output>
