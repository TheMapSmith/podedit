---
phase: 05-export-finalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/services/exportService.js, index.html]
autonomous: true

must_haves:
  truths:
    - "User can click Export button and download a JSON file"
    - "JSON contains the audio filename"
    - "JSON contains all cut regions with start/end timestamps"
    - "JSON format is parsable by ffmpeg scripts (plain seconds)"
  artifacts:
    - path: "src/services/exportService.js"
      provides: "JSON generation and file download"
      exports: ["ExportService"]
    - path: "index.html"
      provides: "Export button in UI"
      contains: "export-btn"
  key_links:
    - from: "index.html"
      to: "ExportService"
      via: "import and button click handler"
      pattern: "exportService\\.export"
    - from: "ExportService.export"
      to: "cutController.getCutRegions"
      via: "function call"
      pattern: "getCutRegions"
---

<objective>
Add JSON export functionality for cut regions

Purpose: Enable users to download their marked cut points as a JSON file that can be used by downstream ffmpeg scripts to perform the actual audio editing.

Output: Working Export button that downloads JSON with filename and cut timestamps
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/controllers/cutController.js
@src/models/cutRegion.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportService with JSON formatting and download</name>
  <files>src/services/exportService.js</files>
  <action>
Create ExportService class in src/services/exportService.js with:

1. `generateCutList(filename, cutRegions)` method that returns a JSON object:
   ```javascript
   {
     "version": "1.0",
     "filename": "podcast.mp3",
     "exported_at": "2026-01-23T12:00:00.000Z",
     "cuts": [
       { "start": 135.5, "end": 182.3 },
       { "start": 450.0, "end": 512.8 }
     ]
   }
   ```
   - version field for future compatibility
   - filename from loaded audio file
   - exported_at is ISO timestamp
   - cuts array with start/end in seconds (numbers, not formatted strings)
   - Cut regions sorted by start time

2. `downloadJson(data, filename)` method that:
   - Creates Blob with JSON.stringify(data, null, 2) for pretty printing
   - Creates object URL and triggers download via hidden anchor element
   - Uses filename like "podcast-cuts.json" (derived from audio filename)
   - Revokes object URL after download triggers

3. `export(audioFilename, cutRegions)` convenience method that:
   - Calls generateCutList
   - Calls downloadJson with derived filename
   - Returns the generated JSON object (useful for testing/verification)
  </action>
  <verify>
Create test file to verify:
```javascript
import ExportService from './src/services/exportService.js';
const service = new ExportService();
const result = service.generateCutList('test.mp3', [
  { startTime: 10, endTime: 20 },
  { startTime: 5, endTime: 8 }
]);
console.log(result.cuts[0].start === 5); // true (sorted)
console.log(result.filename === 'test.mp3'); // true
```
  </verify>
  <done>ExportService exists and correctly generates JSON with sorted cuts and proper format</done>
</task>

<task type="auto">
  <name>Task 2: Add Export button to UI and wire up functionality</name>
  <files>index.html</files>
  <action>
Add Export button to index.html in the cut-section:

1. In CSS, add styles for #export-btn:
   - Same styling pattern as other buttons (padding, border-radius, etc.)
   - Blue color (#007bff) to distinguish from red Mark Start and green Mark End
   - Disabled state styling

2. In HTML, add Export button after the cut-buttons div in cut-section:
   ```html
   <div class="export-controls">
     <button id="export-btn" disabled>Export Cuts</button>
   </div>
   ```

3. In script module:
   - Import ExportService
   - Initialize exportService instance
   - Add reference to export button in elements object
   - Wire click handler that:
     - Gets cuts from cutController.getCutRegions()
     - Gets filename from elements.fileInput.files[0]?.name
     - Calls exportService.export(filename, cuts)
   - Enable export button when file is loaded AND cuts exist
   - Update onCutListChanged callback to enable/disable export button based on cuts.length > 0

4. Disable export button when:
   - No file loaded
   - No cuts marked (cuts.length === 0)
  </action>
  <verify>
Manual test:
1. Load an audio file
2. Mark at least one cut region (Mark Start at 10s, Mark End at 20s)
3. Click Export Cuts button
4. Verify JSON file downloads
5. Open JSON file and verify:
   - filename matches loaded file
   - cuts array contains the marked region
   - start/end are numbers in seconds
  </verify>
  <done>Export button appears in UI, is properly enabled/disabled, and clicking it downloads valid JSON</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Load audio file -> Export button disabled (no cuts)
2. Mark a cut region -> Export button enabled
3. Click Export -> JSON downloads
4. Delete all cuts -> Export button disabled
5. JSON file contains correct data structure
</verification>

<success_criteria>
- User can click "Export Cuts" button and download JSON file
- JSON contains filename, version, timestamp, and cuts array
- Cuts are sorted by start time with seconds as numbers
- Export button only enabled when cuts exist
</success_criteria>

<output>
After completion, create `.planning/phases/05-export-finalization/05-01-SUMMARY.md`
</output>
