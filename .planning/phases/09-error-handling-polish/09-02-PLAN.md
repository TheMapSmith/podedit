---
phase: 09-error-handling-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
autonomous: true

must_haves:
  truths:
    - "User sees estimated processing time before triggering processing"
    - "User sees FFmpeg console logs in real-time to verify processing is progressing"
    - "User sees visual progress bar during processing"
  artifacts:
    - path: "index.html"
      provides: "Processing time estimate, progress bar, log panel"
      contains: "estimated-time"
  key_links:
    - from: "index.html"
      to: "audioProcessingService.processAudio"
      via: "progress callback displays logs"
      pattern: "ffmpeg-logs"
---

<objective>
Add processing time estimation and real-time FFmpeg log display

Purpose: Give users visibility into long-running processing operations (3-6 min) so they know it's working
Output: Estimated time display before processing, visual progress bar, expandable FFmpeg log panel
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/services/audioProcessingService.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add processing time estimation display</name>
  <files>index.html</files>
  <action>
Add estimated time display before Export Edited Audio button:

1. Add estimation function in script:
   ```javascript
   /**
    * Estimate processing time based on audio duration and file size
    * Multi-threaded FFmpeg: roughly 3-6 min for 60-min podcast
    * Single-thread (iOS Safari): roughly 6-12 min for 60-min podcast
    * @param {number} durationSeconds - Audio duration in seconds
    * @param {number} fileSizeBytes - File size in bytes
    * @returns {{ minMinutes: number, maxMinutes: number, formatted: string }}
    */
   function estimateProcessingTime(durationSeconds, fileSizeBytes) {
     // Base estimate: 1 minute processing per 10 minutes of audio (multi-threaded)
     // Add file size factor: larger files take longer
     const durationMinutes = durationSeconds / 60;
     const fileSizeMB = fileSizeBytes / (1024 * 1024);

     // Base time from duration
     let minMinutes = Math.ceil(durationMinutes / 20); // Optimistic: 20 min audio per 1 min processing
     let maxMinutes = Math.ceil(durationMinutes / 10); // Conservative: 10 min audio per 1 min processing

     // Add file size factor (larger files = more I/O)
     if (fileSizeMB > 30) {
       minMinutes += 1;
       maxMinutes += 2;
     }

     // Minimum bounds
     minMinutes = Math.max(1, minMinutes);
     maxMinutes = Math.max(2, maxMinutes);

     // Check for iOS Safari (2x slower)
     if (browserCompat.detectIOSSafari()) {
       minMinutes *= 2;
       maxMinutes *= 2;
     }

     const formatted = minMinutes === maxMinutes
       ? `~${minMinutes} minute${minMinutes > 1 ? 's' : ''}`
       : `${minMinutes}-${maxMinutes} minutes`;

     return { minMinutes, maxMinutes, formatted };
   }
   ```

2. Add estimate display element (after processing-status, before test-ffmpeg-btn):
   ```html
   <div id="processing-estimate" class="processing-estimate" style="display: none;"></div>
   ```

3. Add CSS for estimate display:
   ```css
   .processing-estimate {
     margin: 10px 0;
     padding: 10px 12px;
     background: #fff3cd;
     border: 1px solid #ffc107;
     border-radius: 4px;
     color: #856404;
     font-size: 14px;
   }
   ```

4. Add element reference:
   ```javascript
   processingEstimate: document.getElementById('processing-estimate')
   ```

5. Show estimate when Export Edited Audio button is clicked (before processing starts):
   - Calculate estimate using estimateProcessingTime(duration, currentFile.size)
   - Display: "Estimated processing time: {formatted}"
   - Hide estimate when processing completes or is cancelled

6. In Export Audio click handler, before calling processAudio:
   ```javascript
   const estimate = estimateProcessingTime(duration, currentFile.size);
   elements.processingEstimate.textContent = `Estimated processing time: ${estimate.formatted}`;
   elements.processingEstimate.style.display = 'block';
   ```

7. Hide estimate in finally block:
   ```javascript
   elements.processingEstimate.style.display = 'none';
   ```
  </action>
  <verify>Estimated time appears when Export Edited Audio is clicked, before processing starts</verify>
  <done>Processing time estimate displays based on audio duration and file size</done>
</task>

<task type="auto">
  <name>Task 2: Add visual progress bar and FFmpeg log panel</name>
  <files>index.html</files>
  <action>
Add visual progress bar and expandable FFmpeg log panel:

1. Add progress bar HTML (inside processing-status area):
   Replace simple text status with structured progress display:
   ```html
   <div id="processing-status" class="processing-status" style="display: none;">
     <div class="processing-header">
       <span id="processing-text">Preparing...</span>
       <button id="toggle-logs-btn" class="toggle-logs-btn">Show Logs</button>
     </div>
     <div class="processing-progress-bar">
       <div id="processing-progress-fill" class="progress-fill"></div>
     </div>
     <div id="ffmpeg-logs" class="ffmpeg-logs" style="display: none;"></div>
   </div>
   ```

2. Add CSS for progress bar and log panel:
   ```css
   .processing-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 8px;
   }

   .toggle-logs-btn {
     padding: 4px 8px;
     font-size: 12px;
     background: transparent;
     border: 1px solid currentColor;
     border-radius: 4px;
     cursor: pointer;
     color: inherit;
   }

   .toggle-logs-btn:hover {
     background: rgba(0,0,0,0.05);
   }

   .processing-progress-bar {
     height: 8px;
     background: #dee2e6;
     border-radius: 4px;
     overflow: hidden;
     margin-bottom: 8px;
   }

   .progress-fill {
     height: 100%;
     background: #007bff;
     width: 0%;
     transition: width 0.3s ease;
   }

   .ffmpeg-logs {
     max-height: 150px;
     overflow-y: auto;
     font-family: monospace;
     font-size: 11px;
     background: #1e1e1e;
     color: #d4d4d4;
     padding: 8px;
     border-radius: 4px;
     margin-top: 8px;
   }

   .ffmpeg-log-line {
     white-space: pre-wrap;
     word-break: break-all;
   }
   ```

3. Add element references:
   ```javascript
   processingText: document.getElementById('processing-text'),
   processingProgressFill: document.getElementById('processing-progress-fill'),
   toggleLogsBtn: document.getElementById('toggle-logs-btn'),
   ffmpegLogs: document.getElementById('ffmpeg-logs')
   ```

4. Add toggle logs button handler:
   ```javascript
   let logsVisible = false;
   elements.toggleLogsBtn.addEventListener('click', () => {
     logsVisible = !logsVisible;
     elements.ffmpegLogs.style.display = logsVisible ? 'block' : 'none';
     elements.toggleLogsBtn.textContent = logsVisible ? 'Hide Logs' : 'Show Logs';
   });
   ```

5. Modify progress callback to update progress bar and capture logs:
   ```javascript
   const onProgress = (progress) => {
     // Update progress bar
     elements.processingProgressFill.style.width = `${progress.progress}%`;

     // Update text
     if (progress.stage === 'loading') {
       elements.processingText.textContent = `Loading FFmpeg: ${progress.progress}%`;
     } else if (progress.stage === 'processing') {
       elements.processingText.textContent = `Processing audio: ${progress.progress}%`;
     } else if (progress.stage === 'complete') {
       elements.processingText.textContent = 'Preparing download...';
     }
   };
   ```

6. Add log capture via modified AudioProcessingService:
   - Expose lastLogs getter in AudioProcessingService (or use callback)
   - For simpler approach, add a log callback to onProgress:

   In AudioProcessingService._processAudioInternal, modify FFmpeg log handler to also call onProgress with log:
   ```javascript
   // In log handler, after capturing to lastLogs:
   if (onProgress) {
     onProgress({ stage: 'log', message: message });
   }
   ```

7. Handle log messages in UI callback:
   ```javascript
   const onProgress = (progress) => {
     if (progress.stage === 'log') {
       const logLine = document.createElement('div');
       logLine.className = 'ffmpeg-log-line';
       logLine.textContent = progress.message;
       elements.ffmpegLogs.appendChild(logLine);
       // Auto-scroll to bottom
       elements.ffmpegLogs.scrollTop = elements.ffmpegLogs.scrollHeight;
       return; // Don't process other updates for log messages
     }
     // ... rest of progress handling
   };
   ```

8. Clear logs when starting new processing:
   ```javascript
   elements.ffmpegLogs.innerHTML = '';
   ```

9. Reset progress bar in finally block:
   ```javascript
   elements.processingProgressFill.style.width = '0%';
   ```
  </action>
  <verify>Progress bar fills during processing, logs appear in expandable panel, Show/Hide toggle works</verify>
  <done>Visual progress bar shows percentage, FFmpeg logs display in real-time in expandable panel</done>
</task>

</tasks>

<verification>
1. Click Export Edited Audio
2. Estimated time appears immediately
3. Progress bar fills from 0% to 100% during processing
4. Click "Show Logs" - FFmpeg output appears
5. Logs scroll automatically as new lines appear
6. Click "Hide Logs" - log panel collapses
7. On success/cancel/error, progress bar resets, estimate hides
</verification>

<success_criteria>
- Estimated processing time shown before processing starts
- Progress bar visually indicates 0-100% progress
- FFmpeg logs visible via toggle button
- Logs auto-scroll to show latest output
- All UI elements reset properly after processing completes
</success_criteria>

<output>
After completion, create `.planning/phases/09-error-handling-polish/09-02-SUMMARY.md`
</output>
