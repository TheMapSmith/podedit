---
phase: 09-error-handling-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/audioProcessingService.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can click cancel button to abort processing operation before completion"
    - "User sees cancel button when processing is active"
    - "Processing stops when cancel is clicked"
    - "UI recovers to ready state after cancel"
  artifacts:
    - path: "src/services/audioProcessingService.js"
      provides: "Cancel/abort processing capability"
      contains: "cancel"
    - path: "index.html"
      provides: "Cancel button UI"
      contains: "cancel-btn"
  key_links:
    - from: "index.html"
      to: "AudioProcessingService.cancel"
      via: "click handler"
      pattern: "cancel"
---

<objective>
Add cancel button and abort processing capability

Purpose: Allow users to stop long-running audio processing operations (3-6 min for 60-min podcast)
Output: Working cancel button that aborts FFmpeg processing and returns UI to ready state
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/services/audioProcessingService.js
@src/services/browserCompatibility.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cancel/abort capability to AudioProcessingService</name>
  <files>src/services/audioProcessingService.js</files>
  <action>
Add abort controller pattern to AudioProcessingService:

1. Add instance properties in constructor:
   - `this.abortController = null;` - AbortController for current operation
   - `this.cancelRequested = false;` - Flag to track cancel state

2. Add cancel() method:
   ```javascript
   /**
    * Cancel the current processing operation
    * @returns {boolean} - true if cancel was initiated, false if no operation running
    */
   cancel() {
     if (!this._isProcessing) {
       return false;
     }
     this.cancelRequested = true;
     // FFmpeg.wasm doesn't have native abort, but we can:
     // 1. Set flag to prevent further progress
     // 2. Let timeout handle cleanup
     // 3. Reject with cancel error in processing loop
     return true;
   }
   ```

3. Modify _processAudioInternal to check cancelRequested:
   - After each major step (FFmpeg load, write, exec), check `if (this.cancelRequested) throw new Error('Processing cancelled by user');`
   - The existing finally block will handle cleanup

4. Reset cancelRequested at start of processAudio() and in finally block

5. Add specific error handling for cancel in the catch block:
   - Check if error.message includes 'cancelled'
   - Map to user-friendly "Processing cancelled" message
  </action>
  <verify>Service has cancel() method that returns true when processing, false otherwise</verify>
  <done>AudioProcessingService.cancel() method exists and cancelRequested flag is checked during processing</done>
</task>

<task type="auto">
  <name>Task 2: Add cancel button UI and wire to service</name>
  <files>index.html</files>
  <action>
Add cancel button next to Export Edited Audio button:

1. Add cancel button in export-controls div (after export-audio-btn):
   ```html
   <button id="cancel-processing-btn" style="display: none;">Cancel</button>
   ```

2. Add CSS for cancel button (red, warning style):
   ```css
   #cancel-processing-btn {
     padding: 10px 20px;
     font-size: 14px;
     font-weight: 600;
     color: white;
     background: #dc3545;
     border: none;
     border-radius: 6px;
     cursor: pointer;
     transition: background 0.2s;
     margin-left: 10px;
   }
   #cancel-processing-btn:hover {
     background: #c82333;
   }
   ```

3. Add element reference:
   ```javascript
   cancelBtn: document.getElementById('cancel-processing-btn')
   ```

4. Modify Export Audio click handler:
   - Show cancel button when processing starts: `elements.cancelBtn.style.display = 'inline-block';`
   - Hide cancel button in finally block: `elements.cancelBtn.style.display = 'none';`

5. Add cancel button click handler:
   ```javascript
   elements.cancelBtn.addEventListener('click', () => {
     if (audioProcessingService.cancel()) {
       elements.processingStatus.textContent = 'Cancelling...';
     }
   });
   ```

6. Handle cancel error in catch block - show as info (blue/neutral) not error (red):
   - If error.message includes 'cancelled', use info styling instead of error styling
  </action>
  <verify>Cancel button appears during processing and disappears after. Clicking cancel stops processing.</verify>
  <done>Cancel button visible during processing, click aborts operation, UI returns to ready state</done>
</task>

</tasks>

<verification>
1. Start processing a file with cuts
2. Cancel button appears
3. Click cancel
4. Processing stops
5. Status shows "Processing cancelled" (not error styling)
6. Cancel button hides
7. Export buttons re-enable
8. Can start new processing operation
</verification>

<success_criteria>
- Cancel button appears only during active processing
- Clicking cancel stops processing within a few seconds
- UI recovers cleanly - buttons re-enabled, status shows cancel confirmation
- User can immediately start new processing after cancel
</success_criteria>

<output>
After completion, create `.planning/phases/09-error-handling-polish/09-01-SUMMARY.md`
</output>
