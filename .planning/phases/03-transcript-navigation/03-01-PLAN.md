---
phase: 03-transcript-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/controllers/transcriptController.js
  - src/components/playerController.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can click any word in the transcript and audio jumps to that timestamp"
    - "User can see the currently-playing word highlighted during playback"
    - "Transcript auto-scrolls to keep current word visible during playback"
    - "User can manually scroll transcript and auto-scroll temporarily pauses"
  artifacts:
    - path: "src/controllers/transcriptController.js"
      provides: "Navigation methods: click-to-seek, onTimeUpdate, updateHighlight"
      contains: "setupClickToSeek"
    - path: "src/components/playerController.js"
      provides: "Time update callback support"
      contains: "onTimeUpdate"
    - path: "index.html"
      provides: "CSS for active word highlighting"
      contains: ".transcript-word.active"
  key_links:
    - from: "index.html"
      to: "transcriptController.onTimeUpdate"
      via: "playerController.onTimeUpdate callback"
      pattern: "playerController\\.onTimeUpdate"
    - from: "transcriptController.setupClickToSeek"
      to: "audioService.seek"
      via: "click event delegation"
      pattern: "audioService\\.seek"
---

<objective>
Implement bidirectional transcript-audio navigation: clicking words seeks audio, playing audio highlights and scrolls to current word.

Purpose: This is the core navigation feature that makes transcript-driven editing possible. Users can click to jump to any point, and follow along visually during playback.

Output:
- TranscriptController with click-to-seek and auto-scroll
- PlayerController extended with time update callback
- Visual highlighting CSS for active word
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transcript-navigation/03-RESEARCH.md

@src/controllers/transcriptController.js
@src/components/playerController.js
@src/services/audioService.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add navigation methods to TranscriptController</name>
  <files>src/controllers/transcriptController.js</files>
  <action>
Extend TranscriptController with navigation capabilities:

1. Add new constructor parameters and state:
   - Accept `audioService` as third constructor parameter
   - Add navigation state: `currentWordIndex = -1`, `activeWord = null`, `userIsScrolling = false`, `scrollTimeout = null`

2. Add `setupClickToSeek()` method:
   - Use event delegation on `transcriptContainer` (single click listener)
   - Find clicked word with `event.target.closest('.transcript-word')`
   - Parse `data-start` attribute and call `this.audioService.seek(startTime)`
   - Immediately update highlight on clicked word

3. Add `setupScrollDetection()` method:
   - Listen to scroll events on `transcriptContainer` with `{ passive: true }`
   - Set `userIsScrolling = true` on scroll
   - Clear and reset `scrollTimeout` to disable flag after 1500ms

4. Add `onTimeUpdate(currentTime)` method:
   - Guard: return early if no transcript or no words
   - Call `findCurrentWordIndex(currentTime)` to get new index
   - Only update if index changed AND index >= 0
   - Get word element from `transcriptContainer.children[newIndex]`
   - Call `updateHighlight(wordElement)`

5. Add `findCurrentWordIndex(currentTime)` method:
   - Linear search through `this.transcript.words`
   - Return index where `word.start <= currentTime < word.end`
   - Fallback: return last word where `word.start <= currentTime`
   - Return -1 if no match

6. Add `updateHighlight(newActiveWord)` method:
   - Remove 'active' class from `this.activeWord` if exists
   - Add 'active' class to `newActiveWord` if exists
   - If `!userIsScrolling`, call `newActiveWord.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' })`
   - Store `this.activeWord = newActiveWord`

7. Call `setupClickToSeek()` and `setupScrollDetection()` at end of constructor

8. Update `cleanup()`:
   - Clear `scrollTimeout`
   - Reset navigation state
  </action>
  <verify>
Manual inspection: TranscriptController has setupClickToSeek, setupScrollDetection, onTimeUpdate, findCurrentWordIndex, updateHighlight methods.
Grep: `grep -n "setupClickToSeek\|onTimeUpdate\|updateHighlight" src/controllers/transcriptController.js`
  </verify>
  <done>
TranscriptController has all navigation methods implemented. Constructor accepts audioService parameter. Event delegation for click-to-seek is set up. Scroll detection uses ticking flag pattern with 1500ms timeout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add onTimeUpdate callback to PlayerController</name>
  <files>src/components/playerController.js</files>
  <action>
Extend PlayerController to notify external listeners of time updates:

1. Add `onTimeUpdate` property in constructor:
   - `this.onTimeUpdate = null;` (callback function, set externally)

2. Modify `updatePlaybackPosition()` method:
   - After updating slider/time display (inside the `if (!this.isSeeking)` block)
   - Add: `if (this.onTimeUpdate) { this.onTimeUpdate(currentTime); }`
   - This reuses the existing rAF loop for 60fps updates

No other changes needed - the rAF loop already runs during playback.
  </action>
  <verify>
Grep: `grep -n "onTimeUpdate" src/components/playerController.js`
Should show: initialization in constructor, call in updatePlaybackPosition
  </verify>
  <done>
PlayerController has onTimeUpdate callback property. The callback is invoked at 60fps during playback with current time value.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up navigation and add CSS</name>
  <files>index.html</files>
  <action>
1. Add CSS for active word highlighting (in the style section, after existing .transcript-word styles):

```css
.transcript-word {
  cursor: pointer;  /* Change from cursor: default */
}

.transcript-word.active {
  background: #ffd700;
  font-weight: 600;
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

/* Smooth scroll container fallback */
.transcript-container {
  scroll-behavior: smooth;
}
```

2. Update TranscriptController instantiation to pass audioService:

Change from:
```javascript
const transcriptController = transcriptionService
  ? new TranscriptController(transcriptionService, { ... })
  : null;
```

To:
```javascript
const transcriptController = transcriptionService
  ? new TranscriptController(transcriptionService, {
      generateButton: elements.generateTranscriptBtn,
      progressContainer: elements.transcriptionProgress,
      progressBar: elements.progressBar,
      progressText: elements.progressText,
      transcriptContainer: elements.transcriptContainer,
      errorDisplay: elements.transcriptionError
    }, audioService)
  : null;
```

3. Wire up PlayerController's onTimeUpdate callback (after both controllers are created):

```javascript
// Wire transcript navigation to player time updates
if (transcriptController) {
  playerController.onTimeUpdate = (currentTime) => {
    transcriptController.onTimeUpdate(currentTime);
  };
}
```
  </action>
  <verify>
1. Open in browser: `python3 -m http.server 8000` then visit http://localhost:8000
2. Upload an audio file
3. Generate transcript (or use cached)
4. Click any word - audio should jump to that timestamp
5. Play audio - current word should highlight yellow and transcript should auto-scroll
6. Manually scroll transcript during playback - auto-scroll should pause for ~1.5 seconds then resume
  </verify>
  <done>
All navigation features work:
- Clicking word seeks audio to that timestamp
- Playing audio highlights current word in yellow
- Transcript auto-scrolls to keep current word centered
- Manual scroll temporarily disables auto-scroll
  </done>
</task>

</tasks>

<verification>
## Functional Tests

1. **Click-to-seek:**
   - Click word near start -> audio jumps to ~0:XX
   - Click word near middle -> audio jumps correctly
   - Click word near end -> audio jumps correctly
   - Clicking between words (whitespace) does nothing

2. **Highlight sync:**
   - Play audio -> current word gets yellow background
   - Only ONE word highlighted at a time (previous cleared)
   - Highlight updates smoothly at 60fps (no jank)

3. **Auto-scroll:**
   - Transcript scrolls to keep current word visible
   - Word stays centered (not at edge)
   - Scroll animation is smooth (not instant jump)

4. **User scroll override:**
   - Play audio, manually scroll transcript
   - Auto-scroll pauses while scrolling
   - Wait 1.5s after stopping scroll -> auto-scroll resumes

5. **Edge cases:**
   - No transcript loaded -> onTimeUpdate returns early (no errors)
   - Seek past all words -> last word highlighted
   - Before first word -> no highlight
</verification>

<success_criteria>
Phase 3 Success Criteria (from ROADMAP.md):
1. User can click any word in the transcript and audio immediately jumps to that timestamp - VERIFIED
2. User can start audio playback and see the transcript automatically scroll to keep current word visible - VERIFIED
3. User can see visual highlighting on the currently-playing word in the transcript - VERIFIED

Requirements:
- NAV-01: User can click timestamp to jump to audio position - COMPLETE
- NAV-02: System auto-scrolls transcript to follow playback position - COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/03-transcript-navigation/03-01-SUMMARY.md`
</output>
