---
phase: 06-foundation-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can run npm run dev and Vite dev server starts on localhost:5173"
    - "User can open browser console and see crossOriginIsolated === true"
    - "SharedArrayBuffer is available in window scope without errors"
    - "Existing app functionality works unchanged after Vite migration"
  artifacts:
    - path: "vite.config.js"
      provides: "Vite configuration with COOP/COEP headers"
      min_lines: 10
    - path: "package.json"
      provides: "Updated scripts using Vite"
      contains: "vite"
  key_links:
    - from: "vite.config.js"
      to: "Cross-Origin-Opener-Policy"
      via: "server.headers configuration"
      pattern: "same-origin"
    - from: "vite.config.js"
      to: "Cross-Origin-Embedder-Policy"
      via: "server.headers configuration"
      pattern: "require-corp"
---

<objective>
Migrate from serve package to Vite with cross-origin isolation headers

Purpose: FFmpeg.wasm multi-threading requires SharedArrayBuffer, which browsers only enable when cross-origin isolation headers (COOP/COEP) are active. The current serve package cannot set these headers, so we must migrate to Vite.

Output:
- Vite dev server with COOP/COEP headers configured
- Updated package.json with Vite scripts
- Existing app working unchanged on new dev server
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vite and configure with COOP/COEP headers</name>
  <files>
    - package.json
    - vite.config.js
  </files>
  <action>
Install Vite as a dev dependency:
```bash
npm install --save-dev vite
```

Create `vite.config.js` at project root with:
```javascript
import { defineConfig } from 'vite';

export default defineConfig({
  server: {
    headers: {
      'Cross-Origin-Opener-Policy': 'same-origin',
      'Cross-Origin-Embedder-Policy': 'require-corp'
    }
  },
  build: {
    target: 'esnext'
  }
});
```

Update `package.json` scripts:
- "dev": "vite"
- "start": "vite"
- "build": "vite build"
- "preview": "vite preview"

Remove serve from dependencies if present (npm uninstall serve).

The headers are critical:
- Cross-Origin-Opener-Policy: same-origin — isolates the browsing context
- Cross-Origin-Embedder-Policy: require-corp — requires cross-origin resources to opt-in

Both headers together enable SharedArrayBuffer which FFmpeg.wasm multi-threading requires.
  </action>
  <verify>
Run dev server and check headers:
```bash
npm run dev
```
In browser console:
```javascript
console.log(crossOriginIsolated); // Should be true
console.log(typeof SharedArrayBuffer); // Should be 'function'
```
Verify with curl:
```bash
curl -I http://localhost:5173 | grep -i "cross-origin"
```
Should show both COOP and COEP headers.
  </verify>
  <done>
- Vite installed and vite.config.js created
- npm run dev starts Vite server on port 5173
- crossOriginIsolated === true in browser console
- SharedArrayBuffer available without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify existing app works with Vite</name>
  <files>
    - index.html
  </files>
  <action>
Vite expects index.html at root (already there) and ES modules (already using them).

Verify these work unchanged:
1. File input and audio loading
2. Transcript generation (if API key available)
3. Cut marking and editing
4. Export JSON functionality

The only potential issue: Vite may handle module resolution differently than serve.

Check:
- All import paths in index.html script tag work
- No 404s in Network tab for JS files
- All services initialize correctly

If any imports break (unlikely), adjust paths. Vite resolves from project root.

Note: Do NOT change any functionality. This task is verification only. If something breaks, fix the import path but do not refactor working code.
  </action>
  <verify>
Manual test the complete v1.0 workflow:
1. npm run dev -> server starts
2. Open http://localhost:5173
3. Upload an MP3 file -> loads successfully, shows duration
4. Play/pause/seek work
5. Mark a cut region (if transcript available, or just by time)
6. Export JSON -> downloads correctly
7. Check browser console for any errors

All v1.0 functionality must work identically.
  </verify>
  <done>
- Vite serves existing app without modification
- All imports resolve correctly (no 404s)
- Audio upload, playback, cut marking, and export all work
- No console errors related to module loading
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Server starts correctly:
```bash
npm run dev
# Should show: Local: http://localhost:5173/
```

2. Headers are correct (in new terminal):
```bash
curl -I http://localhost:5173 2>/dev/null | grep -i cross-origin
# Should show both COOP and COEP headers
```

3. Browser isolation enabled:
Open http://localhost:5173 and in console:
```javascript
crossOriginIsolated === true  // must be true
typeof SharedArrayBuffer === 'function'  // must be true
```

4. App functionality unchanged:
Complete a full workflow - upload, play, mark cut, export JSON
</verification>

<success_criteria>
- Vite dev server runs with npm run dev
- Cross-origin isolation headers are active (COOP + COEP)
- crossOriginIsolated === true in browser
- SharedArrayBuffer is available in window scope
- All v1.0 functionality works unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-configuration/06-01-SUMMARY.md`

Document:
- Vite configuration details
- Header verification results
- Any adjustments made for compatibility
</output>
